# Push Notifications Mobile App (Flutter + FCM)

This sample shows a minimal, production‑ready integration of Firebase Cloud Messaging (FCM) in a Flutter app for Android and iOS. Use it as a reference to add push notifications to your own apps.

It demonstrates:

- Firebase initialization via FlutterFire
- Foreground notifications (in-app handling)
- Background/terminated notifications via a top-level background handler
- Handling notification taps (opened/initial message)
- Token retrieval, copy, and refresh
- Topic subscribe/unsubscribe (example topic: `test`)

## How it works

Key code lives in `lib/main.dart`:

- Firebase init: `Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform)` using `lib/firebase_options.dart` generated by FlutterFire.
- Background handler: `_firebaseMessagingBackgroundHandler(RemoteMessage)` is a top‑level function annotated with `@pragma('vm:entry-point')` and is registered with `FirebaseMessaging.onBackgroundMessage(...)`.
- Permissions: Requests notification permission at startup (iOS prompts, Android auto‑granted on API < 33; on 33+ the runtime permission is required).
- Foreground messages: Listened with `FirebaseMessaging.onMessage` and shown in the app UI/logs.
- App opened from a notification: `FirebaseMessaging.onMessageOpenedApp`.
- App launched from terminated by tapping a notification: `FirebaseMessaging.instance.getInitialMessage()`.
- Device token: fetched with `FirebaseMessaging.instance.getToken()` and shown in the UI/logs.
- Topic: subscribe/unsubscribe to a `test` topic for easy broadcast testing.

## Prerequisites

- Flutter SDK installed and configured
- A Firebase project (already created)
- Node.js + Firebase CLI (for testing and/or FlutterFire): `npm i -g firebase-tools`
- FlutterFire CLI: `dart pub global activate flutterfire_cli`
- Android: Android Studio or SDK, a device or an emulator with Google Play services
- iOS: Xcode and a physical iOS device (simulator can’t receive push)

## Project structure (relevant parts)

- `lib/main.dart` — FCM setup, handlers, and demo UI
- `lib/firebase_options.dart` — Generated by `flutterfire configure`
- `android/app/build.gradle` — Android app config; ensure `minSdkVersion 23` and Google Services plugin applied
- `android/app/google-services.json` — Firebase config for Android
- `ios/Runner/GoogleService-Info.plist` — Firebase config for iOS

## Setup

1) Install dependencies

```powershell
flutter pub get
```

2) Connect the app to your Firebase project (FlutterFire)

If not already done, run in the project root:

```powershell
# Ensure CLI tools are available
firebase --version
flutterfire --version

# Log in for FlutterFire to fetch your projects
firebase login --no-localhost

# Configure FlutterFire (choose your Firebase project and platforms)
flutterfire configure --project YOUR_PROJECT_ID --platforms android,ios
```

This generates/updates `lib/firebase_options.dart` and inserts required platform config.

3) Android configuration

- Place your `google-services.json` at: `android/app/google-services.json`.
- Ensure Google Services plugin is enabled. The Flutter template already applies it in `android/app/build.gradle`:

```gradle
plugins {
    id 'com.android.application'
    id 'com.google.gms.google-services'   // <-- here
    id 'kotlin-android'
    id 'dev.flutter.flutter-gradle-plugin'
}
```

- Min SDK must be 23 or above (required by `firebase_messaging`). In `android/app/build.gradle`:

```gradle
defaultConfig {
    // ...existing values...
    minSdkVersion 23
}
```

- If targeting Android 13+ (SDK 33+), request the POST_NOTIFICATIONS permission in your `AndroidManifest.xml` and via runtime (the sample calls `requestPermission()`):

```xml
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

4) iOS configuration

- Add `ios/Runner/GoogleService-Info.plist` (download from Firebase console).
- In Xcode > Runner target:
  - Capabilities: enable Push Notifications.
  - Background Modes: enable "Remote notifications".
- In Firebase console > Project Settings > Cloud Messaging: configure your APNs key/certificate.

## Run

Use a real device or a Play‑enabled emulator:

```powershell
flutter clean
flutter pub get
flutter run
```

The Debug Console prints the device token as `FCM token: ...`.


## Test FCM quickly

1) From Firebase Console

- Go to Cloud Messaging > Send message > "Send test message".
- Paste the device token printed by the app.
- Add a title/body and send.
- Behavior:
  - Foreground: you will see logs/UI updates (Android won’t show a system banner by default for foreground messages).
  - Background/terminated: the system displays the notification; tapping it is captured by the app and shown in the log/UI.

2) Send a data‑only message (exercise background handler)

Use HTTP v1 to send a data‑only payload while the app is in background/terminated. Requires `gcloud` to obtain an access token.

```powershell
# Authenticate once
gcloud auth application-default login

# Variables
$PROJECT_ID = "your-firebase-project-id"
$DEVICE_TOKEN = "paste-your-fcm-token"
$ACCESS_TOKEN = gcloud auth application-default print-access-token

# Build JSON body
$BODY = @{
  message = @{
    token = $DEVICE_TOKEN
    data  = @{ kind = "ping"; ts = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds().ToString() }
  }
} | ConvertTo-Json

# Send
Invoke-RestMethod `
  -Method Post `
  -Uri "https://fcm.googleapis.com/v1/projects/$PROJECT_ID/messages:send" `
  -Headers @{ Authorization = "Bearer $ACCESS_TOKEN"; "Content-Type" = "application/json; charset=UTF-8" } `
  -Body $BODY
```

The app’s top‑level background handler logs: `BG message <id>: { ...data }`.


## Troubleshooting

- FlutterFire cannot list Firebase projects
  - Update CLIs: `npm i -g firebase-tools`; `dart pub global activate flutterfire_cli`
  - Ensure PATH includes: `%USERPROFILE%\AppData\Roaming\npm` and `%USERPROFILE%\AppData\Local\Pub\Cache\bin`
  - Login: `firebase login --no-localhost`
  - List projects: `firebase projects:list`
  - Then: `flutterfire configure --project YOUR_PROJECT_ID --platforms android,ios --verbose`

- Android build fails with minSdk error (21 vs 23)
  - Set `minSdkVersion 23` in `android/app/build.gradle`.

- Kotlin/Gradle plugin mismatch
  - Ensure Kotlin plugin version is defined in `android/settings.gradle` plugins block, e.g. `id "org.jetbrains.kotlin.android" version "1.9.24" apply false`.
  - Use a recent Gradle/AGP. Verify with `android/gradlew.bat -v`.

- Token is null on Android
  - Confirm `google-services.json` is in `android/app/` and the Google Services plugin is applied.
  - Use a device/emulator with Google Play services.

- Foreground notifications don’t show a system banner on Android
  - This is expected for "notification" payloads. Use `onMessage` to show an in‑app UI or integrate a local notifications plugin if you need a banner.

- No background logs
  - Send a data‑only message (no `notification` field) so your background handler runs.


## Notes

- `firebase_options.dart` is generated; don’t edit it by hand. Re-run `flutterfire configure` if you change Firebase settings.
- Committing `google-services.json` and `GoogleService-Info.plist` to the repo is common practice for client apps.
- Example topic used by this sample: `test`.


## License

This sample is provided for educational purposes. Use at your own discretion.
